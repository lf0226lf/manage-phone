<!DOCTYPE html>
<html lang="ch">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
	<title>任务</title>
	<link rel="stylesheet" href="css/weui.css">
	<link rel="stylesheet" href="css/common.css">
	<link rel="stylesheet" href="css/iconfont.css">
	<link rel="stylesheet" href="css/manage.css">
</head>

<body ontouchstart>
	<div class="container" id="container">
		<div class="page home js_show">
			<div class="page__bd">
				<div class="weui-cells__title">基本信息</div>
				<div class="weui-cells">
					<div class="weui-cell ">
						<div class="weui-cell__bd">
							<p>发起日期</p>
						</div>
						<div class="weui-cell__ft" id="createTime">2020-05-13</div>
					</div>
					<div class="weui-cell ">
						<div class="weui-cell__bd">
							<p>处理人</p>
						</div>
						<div class="weui-cell__ft" id="handlerMan">赵娴</div>
					</div>
				</div>
				<div class="weui-cells__title">任务信息</div>
				<div class="weui-cells">
					<div class="weui-cell ">
						<div class="weui-cell__bd">
							<p>任务类型</p>
						</div>
						<div class="weui-cell__ft" id="type">商机</div>
					</div>
					<div class="weui-cell" id="projectNameBox" style="display: none;">
						<div class="weui-cell__bd">
							<p>任务关联</p>
						</div>
						<div class="weui-cell__ft" id="projectName">指挥镇江抽奖平台</div>
					</div>
					<div class="weui-cell ">
						<div class="weui-cell__bd">
							<p>要求完成时间</p>
						</div>
						<div class="weui-cell__ft" id="finishTime">2020-05-13</div>
					</div>
					<div class="weui-cell ">
						<div class="weui-cell__bd">
							<p>任务级别</p>
						</div>
						<div class="weui-cell__ft" id="level">一般</div>
					</div>
					<div class="weui-cell ">
						<div class="weui-cell__bd">
							<p>预计工时</p>
						</div>
						<div class="weui-cell__ft"><span id="hopeDaily">2</span>人/日</div>
					</div>
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<p>任务标题</p>
						</div>
						<div class="weui-cell__ft" id="missionName">任务标题</div>
					</div>
					<div class="weui-cell ">
						<div class="weui-cell__bd" style="width: 88px;flex: none;">
							<p>任务描述</p>
						</div>
						<div class="weui-cell__ft" style="flex: 1;" id="missionRemark">任务描述任务描述任务描述任务描述任务描述任务描述任务描述任务描述任务描述任务描述任务描述任务描述任务描述任务描述任务描述任务描述</div>
					</div>
					<div class="weui-cell ">
						<div class="weui-cell__bd">
							<p>任务状态</p>
						</div>
						<div class="weui-cell__ft" id="status">未提交</div>
					</div>
				</div>
				<div id="finishInfo" style="display: none;">
					<div class="weui-cells__title">完成信息</div>
					<div class="weui-cells">
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<p>实际完成时间</p>
							</div>
							<div class="weui-cell__ft" id="actualFinishTime"></div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<p>实际工时</p>
							</div>
							<div class="weui-cell__ft"><span id="actualDaily"></span>人/日</div>
						</div>
						<div class="weui-cell ">
							<div class="weui-cell__bd" style="width: 88px;flex: none;">
								<p>完成描述</p>
							</div>
							<div class="weui-cell__ft" style="flex: 1;" id="finishRemark"></div>
						</div>
					</div>
				</div>

				<!--
				<div class="weui-cells__title">审批信息</div>
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<p>审批时间</p>
						</div>
						<div class="weui-cell__ft">2020/0518</div>
					</div>
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<p>是否同意</p>
						</div>
						<div class="weui-cell__ft">是</div>
					</div>
					<div class="weui-cell ">
						<div class="weui-cell__bd" style="width: 88px;flex: none;">
							<p>审批内容</p>
						</div>
						<div class="weui-cell__ft" style="flex: 1;">审批内容审批内容审批内容审批内容审批内容审批内容审批内容审批内容审批内容</div>
					</div>
				</div>
-->
				<div class="weui-btn-area">
					<a href="javascript:" class="weui-btn weui-btn_primary" id="submitMission" onclick="submitMission()" style="display: none;">提交</a>
					<a href="javascript:" class="weui-btn weui-btn_primary" id="auditMission" onclick="auditMission()" style="display: none;">审核</a>
					<a href="javascript:" class="weui-btn weui-btn_primary" id="editMission" onclick="editMission()" style="display: none;">编辑</a>
					<a href="javascript:" class="weui-btn weui-btn_warn" id="delMission" style="display: none;">删除</a>
					<a class="weui-btn weui-btn_default" href="javascript:" onclick="goBack();">返回</a>
				</div>
			</div>
			<div class="page__ft">
			</div>
		</div>
	</div>
	<div id="dialogs">
		<div class="js_dialog" id="passDialog" style="display: none;">
			<div class="weui-mask"></div>
			<div class="weui-dialog">
				<div class="weui-dialog__hd"><strong class="weui-dialog__title">提示</strong></div>
				<div class="weui-dialog__bd">确定删除任务吗？</div>
				<div class="weui-dialog__ft">
					<a href="javascript:" class="weui-dialog__btn weui-dialog__btn_default">返回</a>
					<a href="javascript:" class="weui-dialog__btn weui-dialog__btn_primary" onclick="confirmDel();">确定</a>
				</div>
			</div>
		</div>
	</div>
	<div id="toast" style="display: none;">
		<div class="weui-mask_transparent"></div>
		<div class="weui-toast">
			<i class="weui-icon-success-no-circle weui-icon_toast"></i>
			<p class="weui-toast__content">操作成功!</p>
		</div>
	</div>
</body></html>

<script src="js/jQuery-2.2.0.min.js"></script>
<script src="js/util.js"></script>
<script src="js/cookie.js"></script>
<script src="js/common.js"></script>
<script>
	var getId = GetRequest();
	var mark;
	//console.log(getId);
	var level = {
		"0": "一般",
		"1": "紧急"
	};
	var type = {
		"0": "商机",
		"1": "项目",
		"2": "行政",
		"3": "其他"
	};
	var missionStatus = {
		"0": "未提交",
		"1": "已提交",
		"2": "已完成",
		"3": "退回"
	};
	init();
	$('#delMission').on('click', function() {
		$('#passDialog').fadeIn(200);
	});
	$('#dialogs').on('click', '.weui-dialog__btn', function() {
		$(this).parents('.js_dialog').fadeOut(200);
	});

	function init() {
		$.ajax({
			url: apiUrl + 'queryMission',
			type: 'GET',
			data: {
				missionId: getId.id
			},
			success: function(result) {
				console.log(result);
				if (result.resultCode!=0){
					delayURL('error.html', 0);
				}
				$('#createTime').text(result.resultData.createTime);
				$('#handlerMan').text(result.resultData.handlerMan);
				$('#handlerMan').text(result.resultData.handlerMan);
				$('#type').text(type[result.resultData.type]);
				$('#finishTime').text(result.resultData.finishTime);
				if (result.resultData.type == '0' || result.resultData.type == '1') {
					$('#projectNameBox').show();
					$('#projectName').text(result.resultData.projectName);
				}
				$('#level').text(level[result.resultData.level]);
				$('#hopeDaily').text(result.resultData.hopeDaily);
				$('#missionName').text(result.resultData.missionName);
				$('#missionRemark').text(result.resultData.missionRemark);
				$('#status').text(missionStatus[result.resultData.status]);
				$('#actualFinishTime').text(result.resultData.actualFinishTime);
				$('#actualDaily').text(result.resultData.actualDaily);
				$('#finishRemark').text(result.resultData.finishRemark);
				console.log(getDdid);
				console.log(result.resultData.createId);
				console.log(result.resultData.handlerId);
				$.ajax({
					url: apiUrl + 'checkTheSame',
					type: 'GET',
					async: false,
					data: {
						createId: result.resultData.createId,
						ddUserId: getDdid
					},
					success: function(result) {
						mark = result.resultData;
						console.log(mark);
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						console.log(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
					}
				});
				if (mark) {
					if (result.resultData.status == 0) {
						$('#finishInfo').hide()
						$('#submitMission').hide();
						$('#auditMission').hide();
						$('#editMission').show();
						$('#delMission').show();
					}
					if (result.resultData.status == 1) {
						$('#finishInfo').show()
						$('#submitMission').hide();
						$('#auditMission').show();
						$('#editMission').hide();
						$('#delMission').hide();
					}
					if (result.resultData.status == 2) {
						$('#finishInfo').show()
						$('#submitMission').hide();
						$('#auditMission').hide();
						$('#editMission').hide();
						$('#delMission').hide();
					}
					if (result.resultData.status == 3) {
						$('#finishInfo').show()
						$('#submitMission').hide();
						$('#auditMission').hide();
						$('#editMission').hide();
						$('#delMission').hide();
					}
				}else{
					if (result.resultData.status == 0) {
						$('#finishInfo').hide()
						$('#submitMission').show();
						$('#auditMission').hide();
						$('#editMission').hide();
						$('#delMission').hide();
					}
					if (result.resultData.status == 1) {
						$('#finishInfo').show()
						$('#submitMission').hide();
						$('#auditMission').hide();
						$('#editMission').hide();
						$('#delMission').hide();
					}
					if (result.resultData.status == 2) {
						$('#finishInfo').show()
						$('#submitMission').hide();
						$('#auditMission').hide();
						$('#editMission').hide();
						$('#delMission').hide();
					}
					if (result.resultData.status == 3) {
						$('#finishInfo').show()
						$('#submitMission').show();
						$('#auditMission').hide();
						$('#editMission').hide();
						$('#delMission').hide();
					}
				}
				if (result.resultData.createId == result.resultData.handlerId) {
					if (result.resultData.status == 0) {
						$('#finishInfo').hide()
						$('#submitMission').show();
						$('#auditMission').hide();
						$('#editMission').show();
						$('#delMission').show();
					}
					if (result.resultData.status == 1) {
						$('#finishInfo').show()
						$('#submitMission').hide();
						$('#auditMission').show();
						$('#editMission').hide();
						$('#delMission').hide();
					}
					if (result.resultData.status == 2) {
						$('#finishInfo').show()
						$('#submitMission').hide();
						$('#auditMission').hide();
						$('#editMission').hide();
						$('#delMission').hide();
					}
					if (result.resultData.status == 3) {
						$('#finishInfo').show()
						$('#submitMission').show();
						$('#auditMission').hide();
						$('#editMission').hide();
						$('#delMission').hide();
					}
				}
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
				console.log(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
			}
		});
	}

	function submitMission() {
		var id = getId.id;
		var url = "task-submit.html?id=" + id;
		window.location.href = url;
	}

	function auditMission() {
		var id = getId.id;
		var url = "task-audit.html?id=" + id;
		window.location.href = url;
	}

	function editMission() {
		var id = getId.id;
		var url = "task-edit.html?id=" + id;
		window.location.href = url;
	}

	function confirmDel() {
		$.ajax({
			url: apiUrl + 'delMission',
			type: 'POST',
			data: {
				missionId: getId.id
			},
			success: function(result) {
				console.log(result);
				var $toast = $('#toast');
				if ($toast.css('display') != 'none') return;
				$toast.fadeIn(100);
				delayURL('home.html', 3);
				setTimeout(function() {
					$toast.fadeOut(100);
				}, 3000);
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
				console.log(XMLHttpRequest.readyState + XMLHttpRequest.status + XMLHttpRequest.responseText);
			}
		});
	}

	function goHome() {
		delayURL('home.html',0);
	}
</script>
